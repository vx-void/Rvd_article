"""
Модуль для управления промптами AI
"""

from enum import Enum
from typing import Dict


class ComponentType(Enum):
    """Типы гидравлических компонентов"""
    ADAPTER = "адаптер"
    FITTING = "фитинг"
    COUPLING = "муфта"
    TEE = "тройник"
    PLUG = "заглушка"
    BANJO = "banjo"
    BRS = "БРС"


class PreprocessingTask(Enum):
    """Задачи предобработки"""
    CLASSIFY = "classify"
    QUANTITY = "quantity"
    SPLIT = "split"


class PromptRepository:
    """Репозиторий промптов"""

    @staticmethod
    def get_preprocessing_prompt(task: PreprocessingTask) -> str:
        """Получение промпта для задачи предобработки"""
        prompts = {
            PreprocessingTask.CLASSIFY: """Ты - специалист по гидравлическим компонентам.
Проанализируй запрос и определи тип гидравлического компонента.
Возможные типы: адаптер, фитинг, муфта, тройник, заглушка, banjo, БРС.
Ответь одним словом - типом компонента, или "неизвестно" если не можешь определить.

Примеры:
Запрос: "переходник BSP 1/2 на DKOL 18" → адаптер
Запрос: "фитинг под 90 градусов 3/4" → фитинг
Запрос: "муфта для шланга 16 мм" → муфта
Запрос: "тройник BSP 1/2" → тройник

Запрос: {query}""",

            PreprocessingTask.QUANTITY: """Извлеки количество компонентов из запроса.
Ответь только числом, или "не указано" если количества нет.

Примеры:
"2 фитинга BSP 1/2" → 2
"нужен адаптер" → не указано
"заказать 5 муфт" → 5

Запрос: {query}""",

            PreprocessingTask.SPLIT: """Раздели текст на отдельные строки, каждая строка - отдельный компонент.
Удали номера, маркеры списка и лишние пробелы.
Ответь только списком строк, по одной на строку.

Пример:
Текст: "1. фитинг BSP 1/2
2. адаптер DKOL 16
3. муфта 12 мм"

Ответ:
фитинг BSP 1/2
адаптер DKOL 16
муфта 12 мм

Текст: {text}"""
        }
        return prompts.get(task, "")

    @staticmethod
    def get_component_prompt(component_type: ComponentType) -> str:
        """Получение промпта для конкретного типа компонента"""
        base_prompt = """Ты - инженер-гидравлик. Извлеки технические параметры из запроса.
Ответь ТОЛЬКО в формате JSON со следующими полями:
{
    "standard": "стандарт (BSP, DKOL, JIC, NPT, METRIC и т.д.) или null",
    "diameter": "диаметр в мм (число) или null",
    "angle": "угол в градусах (0, 45, 90 и т.д.) или null",
    "thread_type": "тип резьбы (наружная, внутренняя, штуцер, гайка) или null",
    "size_key": "размер ключа (если указан) или null",
    "o_ring": "есть ли уплотнительное кольцо (true/false)",
    "locknut": "есть ли контргайка (true/false)",
    "additional_features": ["дополнительные особенности"] или []
}

ВАЖНО:
1. Извлекай ТОЛЬКО то, что явно указано в запросе
2. Не домысливай и не добавляй информацию
3. Если параметр не указан - используй null/false/[]
4. Ответ должен быть ВАЛИДНЫМ JSON, без дополнительного текста

Запрос: {query}"""

        # Специфичные инструкции для разных типов компонентов
        type_specific = {
            ComponentType.ADAPTER: "Это адаптер/переходник между двумя разными соединениями.",
            ComponentType.FITTING: "Это фитинг/соединитель для гидравлических линий.",
            ComponentType.COUPLING: "Это муфта для соединения двух концов.",
            ComponentType.TEE: "Это тройник для разветвления линии.",
            ComponentType.PLUG: "Это заглушка для закрытия отверстия.",
            ComponentType.BANJO: "Это banjo-соединение (штуцер с отверстием).",
            ComponentType.BRS: "Это быстроразъемное соединение (БРС)."
        }

        specific = type_specific.get(component_type, "")
        return f"{specific}\n\n{base_prompt}"

    @staticmethod
    def get_system_prompt() -> str:
        """Базовый системный промпт для извлечения параметров"""
        return """Ты - AI ассистент для автоматического подбора гидравлических компонентов.
Твоя задача - анализировать текстовые запросы пользователей и извлекать из них технические параметры компонентов.

Ты должен:
1. ТОЧНО понимать техническую терминологию в области гидравлики
2. Извлекать ВСЕ указанные параметры
3. НЕ добавлять параметры, которые не указаны в запросе
4. Возвращать результат ТОЛЬКО в заданном формате JSON

Формат вывода:
{
    "component_type": "тип компонента",
    "standard": "стандарт",
    "diameter": диаметр_в_мм,
    "angle": угол_в_градусах,
    "thread_type": "тип резьбы",
    "additional_features": ["особенность1", "особенность2"],
    "size_key": "размер ключа"
}

Примеры правильных ответов:
Запрос: "адаптер BSP 3/4 с наружной резьбой под 45 градусов"
Ответ: {"component_type": "адаптер", "standard": "BSP", "diameter": 19.05, "angle": 45, "thread_type": "наружная", "additional_features": [], "size_key": null}

Запрос: "муфта DKOL 16 мм с уплотнительным кольцом"
Ответ: {"component_type": "муфта", "standard": "DKOL", "diameter": 16, "angle": 0, "thread_type": "наружная", "additional_features": ["уплотнительное_кольцо"], "size_key": null}

Помни: точность критически важна. Ошибка в параметрах может привести к поставке не того компонента."""